async function submitOrder() {
    const dateInput = document.getElementById('delivery-date').value;
    if (!dateInput) return alert("Select a delivery date");

    const now = new Date();
    const selectedDate = new Date(dateInput);
    selectedDate.setHours(0,0,0,0);
    
    const today = new Date();
    today.setHours(0,0,0,0);
    
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    // 1. Basic Date Guards
    if (selectedDate <= today && currentUser.role !== 'manager') {
        return alert("Contact Kitchen Manager for same-day orders.");
    }

    // 2. 1:00 PM Cutoff check for Tomorrow
    if (selectedDate.getTime() === tomorrow.getTime() && now.getHours() >= 13 && currentUser.role !== 'manager') {
        return alert("Past 1:00 PM cutoff for tomorrow.");
    }

    // 3. LEAD TIME CHECK
    const orderItems = [];
    let leadTimeViolation = false;

    activeProducts.forEach(p => {
        const qty = document.getElementById(`qty-${p.id}`).value;
        if (qty > 0) {
            // Calculate minimum allowed date based on lead time
            // If lead_time is 2, and today is Monday, min date is Wednesday
            const minDate = new Date(today);
            minDate.setDate(today.getDate() + (p.lead_time || 1));

            if (selectedDate < minDate && currentUser.role !== 'manager') {
                alert(`ITEM ERROR: "${p.name}" requires ${p.lead_time} days lead time. Earliest delivery for this item is ${minDate.toDateString()}.`);
                leadTimeViolation = true;
            }

            orderItems.push({ name: p.name, quantity: qty, unit: p.unit });
        }
    });

    if (leadTimeViolation) return; // Stop the order if lead time isn't met
    if (orderItems.length === 0) return alert("Order is empty!");

    // ... (rest of the insert code remains the same)
    const { error } = await _supabase.from('orders').insert([{
        venue_id: currentUser.venue,
        delivery_date: dateInput,
        delivery_slot: document.getElementById('delivery-slot').value,
        items: orderItems,
        status: 'submitted'
    }]);

    if (!error) {
        alert("Order Confirmed!");
        handleLogin(); 
    }
}
